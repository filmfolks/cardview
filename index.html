<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Sched - Shooting Schedule</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- Global Styles & Fonts --- */
        :root {
            --primary-color: #3b82f6; --background-color: #111827; --surface-color: #1f2937;
            --text-color: #f3f4f6; --border-color: #374151; --success-color: #22c55e;
            --danger-color: #ef4444; --warning-color: #f59e0b;
            --muted-text-color: #9ca3af;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color); color: var(--text-color); margin: 0; font-size: 16px;
            height: 100vh; 
        }

        #main-app-container, .splash-screen {
            display: none;
        }

        /* --- Splash Screen --- */
        .splash-screen {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .splash-content {
            max-width: 400px;
        }
        .splash-icon {
            font-size: 5rem;
            color: var(--primary-color);
            margin-bottom: 24px;
        }
        .splash-title {
            font-family: "Courier Prime", monospace;
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin: 0 0 8px 0;
        }
        .splash-tagline {
            font-size: 1.125rem;
            color: var(--muted-text-color);
            margin: 0 0 40px 0;
        }
        .start-new-project-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px 32px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .start-new-project-btn:hover {
            background-color: #2563eb;
        }
        .open-project-link {
            display: block;
            margin-top: 20px;
            color: var(--muted-text-color);
            text-decoration: none;
            font-size: 1rem;
        }
        .open-project-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        /* --- Header Styles --- */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--surface-color); padding: 15px 20px; border-bottom: 2px solid var(--border-color);
        }
        .page-header .header-left, .page-header .header-right {
            flex: 1; display: flex; align-items: center; gap: 15px;
        }
        .page-header .header-right { justify-content: flex-end; }
        .page-header .header-center { flex: 2; text-align: center; }
        #app-title {
            font-family: "Courier Prime", monospace;
            margin: 0;
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }

        /* --- Layout & Form Styles --- */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .section { background-color: var(--surface-color); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); }
        .new-scene-form { border-top: 2px solid var(--border-color); margin-top: 30px; padding-top: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; background-color: #374151; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 0.95rem; box-sizing: border-box; font-family: inherit; }
        input::placeholder, textarea::placeholder { color: #9ca3af; }
        input[type="date"], input[type="time"] { color-scheme: dark; }
        #active-sequence-display {
            text-align: center; margin-bottom: 20px; font-size: 1.2rem; color: var(--primary-color);
            font-weight: 600; border: 1px solid var(--border-color); background-color: var(--background-color);
            padding: 10px; border-radius: 8px;
        }
        .form-grid textarea {
            grid-column: 1 / -1;
            resize: vertical;
            min-height: 80px;
        }

        /* --- Floating Label Styles --- */
        .input-wrapper { position: relative; }
        .input-wrapper label {
            position: absolute; top: 50%; left: 12px; transform: translateY(-50%); color: #9ca3af;
            pointer-events: none; transition: all 0.2s ease-in-out; background-color: #374151; padding: 0 4px;
        }
        .input-wrapper .has-label:focus ~ label, .input-wrapper .has-label:valid ~ label {
            top: -8px; left: 8px; transform: translateY(0); font-size: 0.75rem; color: var(--primary-color);
        }

        /* --- Buttons & Dropdowns --- */
        button { padding: 10px 20px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .icon-btn { background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; }
        .icon-btn.small { font-size: 1.2rem; }
        .dropdown-container { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; background-color: #374151;
            min-width: 240px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 10;
            border-radius: 6px; overflow: hidden; margin-top: 10px; left: 0;
        }
        .dropdown-content a { color: var(--text-color); padding: 12px 20px; text-decoration: none; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .dropdown-content a:hover { background-color: var(--primary-color); }
        .dropdown-header { padding: 8px 20px; font-size: 0.8rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; cursor: default; }
        .dropdown-item { padding-left: 35px !important; }
        .dropdown-divider { border: none; height: 1px; background-color: var(--border-color); margin: 8px 0; }
        .show { display: block; }
        .auto-save-status { margin-left: auto; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; }
        .auto-save-status.off { background-color: var(--danger-color); color: white; }
        .auto-save-status.on { background-color: var(--success-color); color: white; }

        /* --- Scene Strip Styles --- */
        .scene-strips-container { display: flex; flex-direction: column; gap: 8px; }
        .scene-strip-wrapper { display: flex; align-items: center; gap: 10px; }
        .scene-strip {
            flex-grow: 1; background-color: var(--background-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 12px 15px; display: flex; align-items: center;
            gap: 15px; overflow-x: auto; white-space: nowrap;
        }
        .strip-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #d1d5db; padding-right: 15px; border-right: 1px solid var(--border-color); }
        .strip-item:last-of-type { border-right: none; padding-right: 0; }
        .strip-item strong { color: var(--text-color); font-weight: 600; }
        .strip-status { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .strip-status.pending { background-color: var(--warning-color); color: #111827; }
        .strip-status.not-shot { background-color: var(--danger-color); color: var(--text-color); }
        .strip-status.done { background-color: var(--success-color); color: var(--text-color); }
        .scene-actions { display: flex; align-items: center; gap: 10px; }
        .share-btn-strip { background: none; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8; }
        .share-btn-strip:hover { opacity: 1; color: var(--primary-color); }
        .edit-btn-strip { background: none; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8; }
        .edit-btn-strip:hover { opacity: 1; color: var(--primary-color); }

        .schedule-break-header {
            background-color: var(--background-color);
            color: #9ca3af;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 6px;
            margin-top: 20px;
            margin-bottom: 5px;
        }
        .sequence-header {
            color: var(--primary-color);
            padding: 5px 12px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Side Panel for Sequences --- */
        .side-panel {
            position: fixed; top: 0; right: -320px; width: 300px; height: 100%;
            background-color: var(--surface-color); box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            z-index: 2000; transition: right 0.3s ease-in-out; display: flex; flex-direction: column;
        }
        .side-panel.open { right: 0; }
        .panel-header {
            display: flex; flex-direction: column; align-items: flex-start; gap: 12px;
            padding: 15px; border-bottom: 1px solid var(--border-color);
        }
        .panel-header h3 { margin: 0; }
        .panel-actions { display: flex; align-items: center; gap: 8px; width: 100%; }
        .panel-sort { flex-grow: 1; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; padding: 4px 6px; font-size: 0.8rem; }
        .panel-list { overflow-y: auto; padding: 10px; flex-grow: 1; }
        .sequence-item, .schedule-break-item {
            display: flex; 
            justify-content: space-between;
            align-items: center;
            width: 100%; 
            padding: 12px 15px; 
            background: none; 
            border: none;
            color: var(--text-color); 
            text-align: left; 
            border-radius: 6px; 
            font-size: 1rem;
            box-sizing: border-box;
            cursor: grab;
        }
        .sequence-item:hover { background-color: var(--background-color); }
        .sequence-item.active { background-color: var(--primary-color); font-weight: bold; }
        .schedule-break-item {
            background-color: var(--background-color); font-weight: bold;
            text-transform: uppercase; font-size: 0.8rem; color: #9ca3af;
            margin-top: 10px;
        }
        .sortable-ghost { opacity: 0.4; background: var(--primary-color); }

        .panel-item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .edit-item-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            margin-left: 5px;
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .edit-item-btn:hover {
            opacity: 1;
            color: var(--primary-color);
        }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
        .modal-content {
            background-color: var(--surface-color); margin: 10% auto; padding: 30px;
            border: 1px solid var(--border-color); width: 90%; max-width: 700px;
            border-radius: 12px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-content.small { max-width: 450px; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input { background-color: var(--background-color); }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .info-content p { line-height: 1.6; margin: 0 0 10px; }
        .info-content strong { color: var(--primary-color); }
        .about-text { font-size: 1.2rem; text-align: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Share Card Template Styles --- */
        #share-card-template { position: absolute; left: -9999px; top: auto; width: 400px; background-color: #1f2937; color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; border-radius: 12px; border: 1px solid #3b82f6; }
        .share-card-content { padding: 25px; display: flex; flex-direction: column; gap: 10px; }
        .share-card-header { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-bottom: 8px; }
        .share-card-header h1 { margin: 0; font-size: 1.5rem; color: var(--primary-color); font-weight: 700; }
        .share-card-header h2 { margin: 5px 0 0; font-size: 1.1rem; font-weight: 400; color: #d1d5db; }
        .share-card-item { font-size: 1.1rem; line-height: 1.5; }
        .share-card-item strong { color: #9ca3af; font-weight: 600; margin-right: 8px; }
        .share-card-item.description { white-space: pre-wrap; word-wrap: break-word; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .footer-project-info { text-align: left; line-height: 1.5; }
        .footer-project-info div { font-size: 0.9rem; }
        .footer-brand { text-align: right; font-weight: 600; font-size: 0.75rem; opacity: 0.5; }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 900px) {
            #app-title { font-size: 1.5rem; }
            .scene-strip { flex-wrap: wrap; white-space: normal; gap: 8px 15px; }
            .strip-item { border-right: none; padding-right: 0; }
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .page-header { flex-wrap: wrap; padding: 10px 15px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 20% auto; padding: 20px; width: 95%; }
            .modal-actions { flex-direction: column-reverse; gap: 10px; }
        }

        /* --- Pagination Styles --- */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        .pagination-controls button {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        .pagination-controls button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .page-info {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <script>
        // =================================================================
        // --- GLOBAL STATE & DATA STRUCTURE ---
        // =================================================================
        let projectData = {
            panelItems: [],
            activeItemId: null,
            projectInfo: {}
        };
        let lastContactPerson = '';
        let activeFilter = { type: 'all', value: '' };
        let autoSaveInterval = null;
        let currentPage = 1;
        const scenesPerPage = 10;

        // =================================================================
        // --- INITIALIZATION ---
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("To Sched Script Initializing...");
            setupEventListeners();
            loadProjectData();
            initializeDragAndDrop();
        });

        // =================================================================
        // --- SETUP ALL EVENT LISTENERS ---
        // =================================================================
        function setupEventListeners() {
            const safeAddListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.error(`Error: Element with ID '${id}' not found.`);
                }
            };
            const addDropdownListener = (id, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', (e) => {
                        e.preventDefault();
                        handler(e);
                        if (document.getElementById('dropdown-menu')) {
                            document.getElementById('dropdown-menu').classList.remove('show');
                        }
                    });
                } else {
                    console.error(`Error: Dropdown element with ID '${id}' not found.`);
                }
            };

            safeAddListener('start-new-project-btn', 'click', () => {
                hideSplashScreen();
                openProjectModal();
            });
            safeAddListener('open-project-link', 'click', (e) => {
                e.preventDefault();
                document.getElementById('file-input').click();
            });
            safeAddListener('schedule-form', 'submit', handleAddScene);
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');
            if(hamburgerBtn && dropdownMenu) {
                hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
            }
            addDropdownListener('new-project-btn', openProjectModal);
            addDropdownListener('open-project-btn', () => document.getElementById('file-input').click());
            addDropdownListener('new-sequence-btn', handleNewSequence);
            addDropdownListener('save-project-btn', saveProjectFile);
            addDropdownListener('save-excel-btn', () => saveAsExcel(true));
            addDropdownListener('share-project-btn', shareProject);
            addDropdownListener('clear-project-btn', clearProject);
            addDropdownListener('info-btn', () => document.getElementById('info-modal').style.display = 'block');
            addDropdownListener('about-btn', () => document.getElementById('about-modal').style.display = 'block');
            const autoSaveBtn = document.getElementById('auto-save-btn');
            if(autoSaveBtn) autoSaveBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAutoSave(); });
            safeAddListener('file-input', 'change', openProjectFile);
            const sequencePanel = document.getElementById('sequence-panel');
            safeAddListener('sequence-hamburger-btn', 'click', () => sequencePanel.classList.add('open'));
            safeAddListener('close-panel-btn', 'click', () => sequencePanel.classList.remove('open'));
            safeAddListener('add-schedule-break-btn', 'click', handleAddScheduleBreak);
            safeAddListener('export-panel-btn', 'click', () => saveAsExcel(false));
            safeAddListener('filter-by-select', 'change', handleFilterChange);
            safeAddListener('close-project-modal', 'click', closeProjectModal);
            safeAddListener('save-project-info-btn', 'click', handleSaveProjectInfo);
            safeAddListener('close-edit-modal', 'click', closeEditModal);
            safeAddListener('save-changes-btn', 'click', handleSaveChanges);
            safeAddListener('delete-scene-btn', 'click', handleDeleteFromModal);
            safeAddListener('close-info-modal', 'click', () => document.getElementById('info-modal').style.display = 'none');
            safeAddListener('close-about-modal', 'click', () => document.getElementById('about-modal').style.display = 'none');
            document.addEventListener('click', (event) => {
                if (hamburgerBtn && dropdownMenu && dropdownMenu.classList.contains('show') && !hamburgerBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
        }

        // =================================================================
        // --- SPLASH SCREEN & APP VISIBILITY ---
        // =================================================================
        function hideSplashScreen() {
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('main-app-container').style.display = 'block';
        }
        function showSplashScreen() {
            document.getElementById('splash-screen').style.display = 'flex';
            document.getElementById('main-app-container').style.display = 'none';
        }

        // =================================================================
        // --- DRAG-AND-DROP INITIALIZATION ---
        // =================================================================
        function initializeDragAndDrop() {
            const listContainer = document.getElementById('sequence-list');
            if(listContainer){
                new Sortable(listContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const item = projectData.panelItems.splice(evt.oldIndex, 1)[0];
                        projectData.panelItems.splice(evt.newIndex, 0, item);
                        saveProjectData();
                    }
                });
            }
        }

        // =================================================================
        // --- SEQUENCE & SCHEDULE BREAK MANAGEMENT ---
        // =================================================================
        function handleNewSequence() {
            let name = prompt("Enter a name for the new sequence:");
            if (name === null) return;
            if (name.trim() === "") name = `Sequence ${projectData.panelItems.filter(i => i.type === 'sequence').length + 1}`;
            const newItem = { type: 'sequence', id: Date.now(), name: name, scenes: [] };
            projectData.panelItems.push(newItem);
            setActiveItem(newItem.id);
        }
        function handleAddScheduleBreak() {
            let name = prompt("Enter a name for the schedule break (e.g., DAY 1):");
            if (name === null || name.trim() === "") return;
            const newItem = { type: 'schedule_break', id: Date.now(), name: name };
            projectData.panelItems.push(newItem);
            saveProjectData();
            renderSequencePanel();
        }
        function handleEditItem(id) {
            const item = projectData.panelItems.find(i => i.id === id);
            if (!item) return;
            const newName = prompt("Enter the new name:", item.name);
            if (newName !== null && newName.trim() !== "") {
                item.name = newName.trim();
                saveProjectData();
                renderSequencePanel(); 
                renderSchedule();    
            }
        }
        function setActiveItem(id) {
            const item = projectData.panelItems.find(i => i.id === id);
            if (item && item.type === 'sequence') {
                projectData.activeItemId = id;
                resetFilter(); 
                saveProjectData();
                renderSequencePanel();
                document.getElementById('sequence-panel').classList.remove('open');
            }
        }
        function renderSequencePanel() {
            const listContainer = document.getElementById('sequence-list');
            listContainer.innerHTML = '';
            projectData.panelItems.forEach(item => {
                const element = document.createElement('div');
                element.dataset.id = item.id;
                const itemName = document.createElement('span');
                itemName.className = 'panel-item-name';
                itemName.textContent = item.name;
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-item-btn';
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editBtn.title = 'Edit Name';
                editBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    handleEditItem(item.id);
                };
                if (item.type === 'sequence') {
                    element.className = `sequence-item ${item.id === projectData.activeItemId && activeFilter.type === 'all' ? 'active' : ''}`;
                    element.onclick = () => setActiveItem(item.id);
                } else if (item.type === 'schedule_break') {
                    element.className = 'schedule-break-item';
                }
                element.appendChild(itemName);
                element.appendChild(editBtn);
                listContainer.appendChild(element);
            });
        }

        // =================================================================
        // --- FILTERING LOGIC ---
        // =================================================================
        function handleFilterChange(e) {
            const filterType = document.getElementById('filter-by-select').value;
            const filterControls = document.getElementById('filter-controls');
            filterControls.innerHTML = ''; 
            if (filterType === 'all') {
                activeFilter = { type: 'all', value: '' };
                renderSchedule();
                return;
            }
            let inputElement;
            const textFilters = ['cast', 'shootLocation', 'sceneSetting'];
            const selectFilters = {
                status: ['Pending', 'NOT SHOT', 'Done'],
                dayNight: ['DAY', 'NIGHT'],
                type: ['INT', 'EXT', 'INT/EXT']
            };
            if (filterType === 'date') {
                inputElement = document.createElement('input');
                inputElement.type = 'date';
            } else if (textFilters.includes(filterType)) {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = `Enter ${filterType.replace(/([A-Z])/g, ' $1').toLowerCase()}`;
            } else if (Object.keys(selectFilters).includes(filterType)) {
                inputElement = document.createElement('select');
                let optionsHTML = `<option value="">Select ${filterType.replace(/([A-Z])/g, ' $1').toLowerCase()}</option>`;
                selectFilters[filterType].forEach(option => {
                    optionsHTML += `<option value="${option}">${option}</option>`;
                });
                inputElement.innerHTML = optionsHTML;
            }
            if (inputElement) {
                inputElement.className = 'panel-sort';
                const updateFilter = (e) => {
                    activeFilter = { type: filterType, value: e.target.value.trim().toLowerCase() };
                    renderSchedule();
                };
                inputElement.addEventListener('change', updateFilter);
                if (inputElement.type === 'text') {
                     inputElement.addEventListener('keyup', updateFilter);
                }
                filterControls.appendChild(inputElement);
            }
            activeFilter = { type: filterType, value: '' }; 
            renderSchedule(); 
        }
        function getGloballyFilteredResults() {
            const results = [];
            const orderedPanelItems = getOrderedPanelItems();
            let currentScheduleBreak = 'Uncategorized';
            orderedPanelItems.forEach(item => {
                if (item.type === 'schedule_break') {
                    currentScheduleBreak = item.name;
                } else if (item.type === 'sequence' && item.scenes) {
                    const matchingScenes = item.scenes.filter(scene => {
                        const sceneProperty = scene[activeFilter.type];
                        if (sceneProperty === undefined || sceneProperty === null) return false;
                        const sceneValue = sceneProperty.toString().toLowerCase();
                        const filterValue = activeFilter.value.toLowerCase();
                        return sceneValue.includes(filterValue);
                    });
                    if (matchingScenes.length > 0) {
                        results.push({
                            scheduleBreak: currentScheduleBreak,
                            sequence: item,
                            scenes: matchingScenes
                        });
                    }
                }
            });
            return results;
        }
        function getVisibleScenes() {
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence || !activeSequence.scenes) return [];
            return activeSequence.scenes;
        }
        function resetFilter() {
            activeFilter = { type: 'all', value: '' };
            currentPage = 1;
            document.getElementById('filter-controls').innerHTML = '';
            const filterSelect = document.getElementById('filter-by-select');
            if (filterSelect) filterSelect.value = 'all';
            renderSchedule();
        }

        // =================================================================
        // --- CORE SCHEDULE FUNCTIONS ---
        // =================================================================
        function handleAddScene(e) {
            e.preventDefault();
            let activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence || activeSequence.type !== 'sequence') {
                alert("Please select a sequence before adding a scene.");
                return;
            }
            const newScene = {
                id: Date.now(), description: document.getElementById('scene-description').value,
                number: document.getElementById('scene-number').value, sceneSetting: document.getElementById('scene-setting').value,
                dayNight: document.getElementById('day-night').value, date: document.getElementById('scene-date').value,
                time: document.getElementById('scene-time').value, type: document.getElementById('scene-type').value,
                shootLocation: document.getElementById('shoot-location').value, pages: document.getElementById('scene-pages').value,
                duration: document.getElementById('scene-duration').value, status: document.getElementById('scene-status').value,
                cast: document.getElementById('scene-cast').value, equipment: document.getElementById('scene-equipment').value,
                contact: document.getElementById('scene-contact').value, notes: document.getElementById('scene-notes').value,
            };
            activeSequence.scenes.push(newScene);
            lastContactPerson = newScene.contact;
            saveProjectData();
            renderSchedule();
            e.target.reset();
            document.getElementById('scene-contact').value = lastContactPerson;
        }
        function renderSchedule() {
            const container = document.getElementById('scene-strips-container');
            const display = document.getElementById('active-sequence-display');
            const pagination = document.getElementById('pagination-controls');
            container.innerHTML = '';
            pagination.innerHTML = '';
            const isGlobalFilterActive = activeFilter.type !== 'all' && activeFilter.value !== '';
            if (isGlobalFilterActive) {
                const filterName = document.querySelector(`#filter-by-select option[value="${activeFilter.type}"]`).textContent;
                display.textContent = `Filtered Results for: "${activeFilter.value}" in ${filterName}`;
                const results = getGloballyFilteredResults();
                if (results.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: #9ca3af;">No scenes found matching the filter.</p>`;
                    return;
                }
                let lastBreak = null;
                results.forEach(result => {
                    if (result.scheduleBreak !== lastBreak) {
                        const breakHeader = document.createElement('div');
                        breakHeader.className = 'schedule-break-header';
                        breakHeader.textContent = result.scheduleBreak;
                        container.appendChild(breakHeader);
                        lastBreak = result.scheduleBreak;
                    }
                    const seqHeader = document.createElement('div');
                    seqHeader.className = 'sequence-header';
                    seqHeader.textContent = result.sequence.name;
                    container.appendChild(seqHeader);
                    result.scenes.forEach(scene => renderSceneStrip(scene, container));
                });
            } else {
                const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
                if (!activeSequence || activeSequence.type !== 'sequence') {
                    display.textContent = 'No active sequence. Create or select a sequence.';
                    return;
                }
                display.textContent = `Current Sequence: ${activeSequence.name}`;
                const allScenes = getVisibleScenes();
                const startIndex = (currentPage - 1) * scenesPerPage;
                const endIndex = startIndex + scenesPerPage;
                const paginatedScenes = allScenes.slice(startIndex, endIndex);
                if (allScenes.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: #9ca3af;">No scenes yet. Add one below!</p>`;
                } else {
                    paginatedScenes.forEach(scene => renderSceneStrip(scene, container));
                }
                renderPaginationControls(allScenes.length, scenesPerPage);
            }
        }
        function renderSceneStrip(scene, container) {
            const stripWrapper = document.createElement('div');
            stripWrapper.className = 'scene-strip-wrapper';
            const statusClass = (scene.status || '').replace(/\s+/g, '-').toLowerCase();
            stripWrapper.innerHTML = `
                <div class="scene-strip" id="scene-strip-${scene.id}">
                    <div class="strip-item"><strong>#${(scene.number || '')}</strong></div>
                    <div class="strip-item">${(scene.type || '')} ${(scene.sceneSetting || '')} - ${(scene.dayNight || '')}</div>
                    <div class="strip-item">${(scene.description || '').substring(0, 50)}...</div>
                    <div class="strip-item">${formatDateDDMMYYYY(scene.date)}</div><div class="strip-item">${formatTime12Hour(scene.time)}</div>
                    <div class="strip-item">Location: <strong>${(scene.shootLocation || '')}</strong></div>
                    <div class="strip-item">Pages: <strong>${scene.pages || 'N/A'}</strong></div>
                    <div class="strip-item">Cast: <strong>${scene.cast || 'N/A'}</strong></div>
                    <div class="strip-item"><span class="strip-status ${statusClass}">${scene.status}</span></div>
                </div>
                <div class="scene-actions">
                    <button class="edit-btn-strip" title="Edit Scene"><i class="fas fa-pencil-alt"></i></button>
                    <button class="share-btn-strip" title="Share as Image"><i class="fas fa-share-alt"></i></button>
                </div>
            `;
            stripWrapper.querySelector('.edit-btn-strip').addEventListener('click', () => openEditModal(scene.id));
            stripWrapper.querySelector('.share-btn-strip').addEventListener('click', () => shareScene(scene.id));
            container.appendChild(stripWrapper);
        }
        function renderPaginationControls(totalItems, itemsPerPage) {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';
            if (totalItems <= itemsPerPage) return;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'btn-primary';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderSchedule();
                }
            });
            const pageInfo = document.createElement('span');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'btn-primary';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderSchedule();
                }
            });
            container.appendChild(prevButton);
            container.appendChild(pageInfo);
            container.appendChild(nextButton);
        }
        function deleteScene(id) {
            projectData.panelItems.forEach(item => {
                if (item.type === 'sequence' && item.scenes) {
                    item.scenes = item.scenes.filter(scene => scene.id !== id);
                }
            });
            saveProjectData();
            renderSchedule();
        }

        // =================================================================
        // --- DATA PERSISTENCE & PROJECT FILES ---
        // =================================================================
        function saveProjectData() {
            localStorage.setItem('projectData', JSON.stringify(projectData));
        }
        function loadProjectData() {
            let savedData = localStorage.getItem('projectData');
            if (!savedData) {
                showSplashScreen();
                return; 
            }
            hideSplashScreen();
            projectData = JSON.parse(savedData);
            if (!projectData.projectInfo) projectData.projectInfo = {};
            if (!projectData.panelItems) projectData.panelItems = [];
            if (projectData.activeItemId === null && projectData.panelItems.length > 0) {
                const firstSequence = projectData.panelItems.find(i => i.type === 'sequence');
                if (firstSequence) projectData.activeItemId = firstSequence.id;
            }
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (activeSequence && activeSequence.scenes && activeSequence.scenes.length > 0) {
                lastContactPerson = activeSequence.scenes[activeSequence.scenes.length - 1].contact || '';
            }
            const contactInput = document.getElementById('scene-contact');
            if (contactInput) contactInput.value = lastContactPerson;
            renderSchedule();
            renderSequencePanel();
        }
        function clearProject() {
            if (confirm('Are you sure you want to clear the entire project? This action cannot be undone.')) {
                localStorage.removeItem('projectData');
                location.reload();
            }
        }
        function openProjectFile(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && Array.isArray(data.panelItems) && data.hasOwnProperty('projectInfo')) {
                        projectData = data;
                        if (!projectData.projectInfo) projectData.projectInfo = {};
                        if (!projectData.panelItems) projectData.panelItems = [];
                        projectData.activeItemId = null; // Reset active item on load
                        if (projectData.panelItems.length > 0) {
                            const firstSequence = projectData.panelItems.find(i => i.type === 'sequence');
                            if (firstSequence) projectData.activeItemId = firstSequence.id;
                        }
                        saveProjectData();
                        hideSplashScreen(); 
                        renderSequencePanel();
                        renderSchedule();
                        alert("Project loaded successfully.");
                    } else {
                        alert("Invalid project file format.");
                    }
                } catch (error) {
                    console.error("Error opening project file:", error);
                    alert("Could not open project file. It may be corrupted or in the wrong format.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.onerror = () => {
                alert("Error reading file.");
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // =================================================================
        // --- MODAL LOGIC ---
        // =================================================================
        function openProjectModal() {
            const projectInfo = projectData.projectInfo || {};
            document.getElementById('prod-name').value = projectInfo.prodName || '';
            document.getElementById('director-name').value = projectInfo.directorName || '';
            document.getElementById('contact-number').value = projectInfo.contactNumber || '';
            document.getElementById('contact-email').value = projectInfo.contactEmail || '';
            document.getElementById('project-info-modal').style.display = 'block';
        }
        function closeProjectModal() { document.getElementById('project-info-modal').style.display = 'none'; }
        function handleSaveProjectInfo() {
            projectData.projectInfo = {
                prodName: document.getElementById('prod-name').value, directorName: document.getElementById('director-name').value,
                contactNumber: document.getElementById('contact-number').value, contactEmail: document.getElementById('contact-email').value
            };
            saveProjectData();
            closeProjectModal();
        }
        function openEditModal(id) {
            let scene;
            for (const item of projectData.panelItems) {
                if (item.type === 'sequence' && item.scenes) {
                    const foundScene = item.scenes.find(s => s.id === id);
                    if (foundScene) { scene = foundScene; break; }
                }
            }
            if (!scene) return;
            document.getElementById('edit-scene-id').value = scene.id;
            document.getElementById('edit-scene-number').value = scene.number || '';
            document.getElementById('edit-scene-description').value = scene.description || '';
            document.getElementById('edit-scene-setting').value = scene.sceneSetting || '';
            document.getElementById('edit-day-night').value = scene.dayNight || 'DAY';
            document.getElementById('edit-scene-date').value = scene.date || '';
            document.getElementById('edit-scene-time').value = scene.time || '';
            document.getElementById('edit-scene-type').value = scene.type || 'INT';
            document.getElementById('edit-shoot-location').value = scene.shootLocation || '';
            document.getElementById('edit-scene-pages').value = scene.pages || '';
            document.getElementById('edit-scene-duration').value = scene.duration || '';
            document.getElementById('edit-scene-status').value = scene.status || 'Pending';
            document.getElementById('edit-scene-cast').value = scene.cast || '';
            document.getElementById('edit-scene-equipment').value = scene.equipment || '';
            document.getElementById('edit-scene-contact').value = scene.contact || '';
            document.getElementById('edit-scene-notes').value = scene.notes || '';
            document.getElementById('edit-scene-modal').style.display = 'block';
        }
        function closeEditModal() { document.getElementById('edit-scene-modal').style.display = 'none'; }
        function handleSaveChanges() {
            const sceneId = parseInt(document.getElementById('edit-scene-id').value);
            let sceneIndex = -1;
            let sequence;
            for (const item of projectData.panelItems) {
                if (item.type === 'sequence' && item.scenes) {
                    sceneIndex = item.scenes.findIndex(s => s.id === sceneId);
                    if (sceneIndex !== -1) {
                        sequence = item;
                        break;
                    }
                }
            }
            if (!sequence || sceneIndex === -1) return;
            sequence.scenes[sceneIndex] = {
                id: sceneId,
                number: document.getElementById('edit-scene-number').value, description: document.getElementById('edit-scene-description').value,
                sceneSetting: document.getElementById('edit-scene-setting').value, dayNight: document.getElementById('edit-day-night').value,
                date: document.getElementById('edit-scene-date').value, time: document.getElementById('edit-scene-time').value,
                type: document.getElementById('edit-scene-type').value, shootLocation: document.getElementById('edit-shoot-location').value,
                pages: document.getElementById('edit-scene-pages').value, duration: document.getElementById('edit-scene-duration').value,
                status: document.getElementById('edit-scene-status').value, cast: document.getElementById('edit-scene-cast').value,
                equipment: document.getElementById('edit-scene-equipment').value, contact: document.getElementById('edit-scene-contact').value,
                notes: document.getElementById('edit-scene-notes').value
            };
            saveProjectData();
            renderSchedule();
            closeEditModal();
        }
        function handleDeleteFromModal() {
            if(confirm("Are you sure you want to delete this scene?")) {
                const sceneId = parseInt(document.getElementById('edit-scene-id').value);
                deleteScene(sceneId);
                closeEditModal();
            }
        }

        // =================================================================
        // --- EXPORT & SHARE FUNCTIONS ---
        // =================================================================
        function getOrderedPanelItems() {
            const listContainer = document.getElementById('sequence-list');
            if (!listContainer) return projectData.panelItems;
            const itemElements = Array.from(listContainer.children);
            const orderedIds = itemElements.map(el => parseInt(el.dataset.id));
            const idMap = new Map(projectData.panelItems.map(item => [item.id, item]));
            const orderedItems = orderedIds.map(id => idMap.get(id)).filter(Boolean);
            return orderedItems;
        }
        function saveAsExcel(isFullProject = false) {
            // This function remains unchanged...
        }
        function createSheet(sequence, scenesToPrint, panelItems) {
            // This function remains unchanged...
        }
        async function shareProject() {
            // This function remains unchanged...
        }
        async function shareScene(id) {
            // This function remains unchanged...
        }
        
        // =================================================================
        // --- UTILITY FUNCTIONS ---
        // =================================================================
        function formatTime12Hour(timeString) {
            if (!timeString) return "N/A";
            const [hour, minute] = timeString.split(':');
            const hourInt = parseInt(hour, 10);
            const ampm = hourInt >= 12 ? 'PM' : 'AM';
            const hour12 = hourInt % 12 || 12;
            return `${hour12}:${minute} ${ampm}`;
        }
        function formatDateDDMMYYYY(dateString) {
            if (!dateString || dateString.indexOf('-') === -1) return dateString || "N/A";
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        function toggleAutoSave() {
            const statusEl = document.getElementById('auto-save-status');
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                statusEl.textContent = 'OFF';
                statusEl.className = 'auto-save-status off';
            } else {
                autoSaveInterval = setInterval(() => { saveProjectData(); }, 120000); 
                statusEl.textContent = 'ON';
                statusEl.className = 'auto-save-status on';
                alert('Auto-save is now ON. Your project will be saved to this browser\'s storage every 2 minutes.');
            }
        }
        function setStatusBarHeight(heightInPixels) {
            const pageHeader = document.querySelector('.page-header');
            if (pageHeader) {
                pageHeader.style.paddingTop = `${heightInPixels}px`;
            }
        }
    </script>

</body>
</html>
