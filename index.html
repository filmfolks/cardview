<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dictionary ‚Äî Translate (Indian languages)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .smooth-scroll { -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-100 to-white min-h-screen flex flex-col items-center p-4">
  <h1 class="text-3xl font-bold text-blue-600 mt-6 mb-4">üìñ Simple Dictionary</h1>

  <!-- Search -->
  <div class="w-full max-w-md flex gap-2">
    <input id="wordInput"
           class="flex-1 p-3 border rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
           placeholder="Enter a word..." onkeydown="if(event.key==='Enter') fetchMeaning()" />
    <button id="searchBtn" onclick="fetchMeaning()"
            class="px-4 py-2 bg-blue-500 text-white rounded-2xl shadow-md hover:bg-blue-600">
      Search
    </button>
  </div>

  <!-- Translate Controls -->
  <div class="w-full max-w-md mt-4 flex gap-2 items-center">
    <select id="langSelect" class="flex-1 p-2 border rounded-xl">
      <optgroup label="Indian languages">
        <option value="as">Assamese (as)</option>
        <option value="bn">Bengali (bn)</option>
        <option value="gu">Gujarati (gu)</option>
        <option value="hi" selected>Hindi (hi)</option>
        <option value="kn">Kannada (kn)</option>
        <option value="ml">Malayalam (ml)</option>
        <option value="mr">Marathi (mr)</option>
        <option value="or">Odia (or)</option>
        <option value="pa">Punjabi (pa)</option>
        <option value="ta">Tamil (ta)</option>
        <option value="te">Telugu (te)</option>
        <option value="ur">Urdu (ur)</option>
        <option value="ne">Nepali (ne)</option>
        <option value="sa">Sanskrit (sa)</option>
      </optgroup>
      <optgroup label="Other">
        <option value="en">English (en)</option>
        <option value="fr">French (fr)</option>
        <option value="de">German (de)</option>
        <option value="es">Spanish (es)</option>
      </optgroup>
    </select>

    <button id="translateBtn" onclick="translateAll()"
            class="px-4 py-2 bg-green-600 text-white rounded-2xl shadow-md hover:bg-green-700">
      Translate
    </button>
  </div>

  <!-- Status & Errors -->
  <p id="loading" class="mt-6 text-gray-600 hidden">Loading...</p>
  <p id="error" class="mt-3 text-red-500 hidden"></p>

  <!-- English Results -->
  <div id="result" class="mt-6 w-full max-w-md hidden bg-white shadow-lg rounded-2xl p-4 smooth-scroll"></div>

  <!-- Translation Results -->
  <div id="translation" class="mt-4 w-full max-w-md hidden bg-green-50 p-3 rounded-xl border border-green-200 smooth-scroll"></div>

<script>
/*
  Behavior:
  - fetchMeaning() -> load dictionaryapi.dev, group definitions by partOfSpeech
  - translateAll() -> translates each definition grouped by partOfSpeech
  - translateWithFallback() -> tries MyMemory -> LibreTranslate -> returns null if fails
  - If translations fail, a Google Translate fallback link is shown.
*/

let groupedDefinitions = {}; // { partOfSpeech: [definitionStrings] }
let lastWord = "";

function setLoading(flag) {
  document.getElementById('loading').classList.toggle('hidden', !flag);
  document.getElementById('searchBtn').disabled = flag;
  document.getElementById('translateBtn').disabled = flag;
}

function showError(msg) {
  const e = document.getElementById('error');
  e.textContent = '‚ùå ' + msg;
  e.classList.remove('hidden');
  console.warn(msg);
}

function clearError() {
  const e = document.getElementById('error');
  e.textContent = '';
  e.classList.add('hidden');
}

async function fetchMeaning() {
  const word = document.getElementById('wordInput').value.trim();
  const resultDiv = document.getElementById('result');
  const translationDiv = document.getElementById('translation');
  if (!word) return;

  setLoading(true);
  clearError();
  resultDiv.innerHTML = '';
  translationDiv.innerHTML = '';
  resultDiv.classList.add('hidden');
  translationDiv.classList.add('hidden');
  groupedDefinitions = {};
  lastWord = word;

  try {
    const resp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
    if (!resp.ok) throw new Error('Word not found in dictionaryapi.dev');
    const data = await resp.json();
    const entry = data[0];

    let html = `
      <div>
        <div class="flex items-baseline justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-gray-800">${entry.word}</h2>
            <p class="italic text-gray-500">${entry.phonetic || ''}</p>
          </div>
        </div>
    `;

    // Group by partOfSpeech
    entry.meanings.forEach(meaning => {
      const pos = meaning.partOfSpeech || 'other';
      const defs = meaning.definitions.map(d => d.definition);
      if (!groupedDefinitions[pos]) groupedDefinitions[pos] = [];
      groupedDefinitions[pos].push(...defs);

      html += `
        <div class="mt-4">
          <p class="font-semibold text-blue-600">${pos}</p>
          <ul class="list-disc list-inside text-gray-700">
            ${defs.map(d => `<li class="mt-1">${escapeHtml(d)}</li>`).join('')}
          </ul>
        </div>
      `;
    });

    html += '</div>';
    resultDiv.innerHTML = html;
    resultDiv.classList.remove('hidden');

  } catch (err) {
    showError(err.message || err);
  } finally {
    setLoading(false);
  }
}

// small helper to avoid injecting raw HTML
function escapeHtml(s) {
  if (!s) return '';
  return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
}

// decode entities MyMemory can return
function decodeEntities(str) {
  const ta = document.createElement('textarea');
  ta.innerHTML = str;
  return ta.value;
}

/* Attempt translations:
   1) MyMemory (free) via GET
   2) LibreTranslate (public instance) via POST
   Returns translated string or null if both fail.
*/
async function translateWithFallback(text, target) {
  // 1) Try MyMemory
  try {
    const mmUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${encodeURIComponent(target)}`;
    const r = await fetch(mmUrl);
    if (r.ok) {
      const j = await r.json();
      let tr = j?.responseData?.translatedText || '';
      // prefer a non-empty, different translation
      if (tr && tr.trim() && tr.trim().toLowerCase() !== text.trim().toLowerCase()) {
        return decodeEntities(tr);
      }
      // fallback to matches array if available
      if (j?.matches?.length) {
        const best = j.matches.find(m => m.translation && m.match > 30) || j.matches[0];
        if (best && best.translation) return decodeEntities(best.translation);
      }
    }
  } catch (e) {
    console.warn('MyMemory failed:', e);
  }

  // 2) Try LibreTranslate public instance as fallback
  try {
    const libreRes = await fetch('https://libretranslate.de/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ q: text, source: 'en', target: target, format: 'text' })
    });
    if (libreRes.ok) {
      const jj = await libreRes.json();
      if (jj?.translatedText) return jj.translatedText;
    }
  } catch (e) {
    console.warn('LibreTranslate failed:', e);
  }

  // both failed
  return null;
}

async function translateAll() {
  const translationDiv = document.getElementById('translation');
  const target = document.getElementById('langSelect').value;

  if (!lastWord || Object.keys(groupedDefinitions).length === 0) {
    translationDiv.innerHTML = "<p class='text-red-600'>‚ö†Ô∏è No word to translate. Search a word first.</p>";
    translationDiv.classList.remove('hidden');
    return;
  }

  translationDiv.innerHTML = `<div class="text-gray-700">üîÑ Translating definitions...</div>`;
  translationDiv.classList.remove('hidden');
  setLoading(true);
  clearError();

  try {
    let anyFailed = false;
    let outHtml = `<p class="font-semibold text-green-700">üåç Translated to ${document.querySelector('#langSelect option:checked').textContent}:</p>`;

    // We'll translate POS-by-POS and keep original structure
    for (const [pos, defs] of Object.entries(groupedDefinitions)) {
      outHtml += `<div class="mt-4"><p class="font-semibold text-green-600">${pos}</p><ul class="list-disc list-inside text-gray-800">`;

      // translate sequentially to avoid rate limit bursts
      for (let i = 0; i < defs.length; i++) {
        const src = defs[i];
        // small progress indicator (console)
        console.log(`Translating (${pos}) [${i+1}/${defs.length}] ‚Üí ${target}`);
        let translated = null;
        try {
          translated = await translateWithFallback(src, target);
        } catch (e) {
          console.warn('translateWithFallback exception', e);
        }
        if (!translated) {
          anyFailed = true;
          translated = '[translation unavailable]';
        }
        outHtml += `<li class="mt-1"><div class="text-gray-500 text-sm"><span class="font-medium">EN:</span> ${escapeHtml(src)}</div>
                    <div class="text-gray-800 mt-1"><span class="font-medium">‚Üí</span> ${escapeHtml(translated)}</div></li>`;
      }

      outHtml += `</ul></div>`;
    }

    // show fallback hint if any failed
    if (anyFailed) {
      outHtml += `
        <div class="mt-3 text-xs text-gray-500">
          Some translations failed (service may not support that language or a rate limit/CORS occurred).
        </div>
      `;
    }

    // Google Translate fallback link (prefills combined definitions)
    const combined = encodeURIComponent(Object.values(groupedDefinitions).flat().join('\\n'));
    const googleLink = `https://translate.google.com/?sl=en&tl=${encodeURIComponent(document.getElementById('langSelect').value)}&text=${combined}&op=translate`;

    outHtml += `<a class="inline-block mt-3 underline text-blue-700" href="${googleLink}" target="_blank" rel="noopener">Open in Google Translate (fallback)</a>`;

    translationDiv.innerHTML = outHtml;

  } catch (err) {
    translationDiv.innerHTML = `<p class="text-red-600">‚ùå ${err.message || err}</p>`;
    console.error(err);
  } finally {
    setLoading(false);
  }
}
</script>
<div id="google_translate_element" class="mt-6"></div>
<script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement(
      {pageLanguage: 'en', includedLanguages: 'as,bn,gu,hi,kn,ml,mr,or,pa,ta,te,ur,ne,sa'},
      'google_translate_element'
    );
  }
  
  
</script>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>
