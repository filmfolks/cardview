<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Screenplay Card View</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; color: #000; margin: 0; padding: 0; }
    #cards-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      width: 98vw;
      max-width: 1350px;
      margin: 60px auto 0 auto;
      padding: 0 0 16px 0;
      min-height: 300px;
      box-sizing: border-box;
    }
    .card {
      background: #fff;
      border: 1px solid #888;
      border-radius: 2px;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      min-height: 80px;
      height: auto;
      aspect-ratio: 1 / 1;
      margin: 0;
      transition: all 0.13s;
      overflow: hidden;
      padding: 10px;
    }
    .scene-heading, .description {
      font-family: inherit;
      color: #000;
      border: 1px solid #888;
      border-radius: 2px;
      padding: 5px 6px;
      margin-bottom: 6px;
      font-size: 14px;
      resize: none;
      outline: none;
      background: #fff;
      transition: border 0.15s;
      box-sizing: border-box;
    }
    .scene-heading {
      font-weight: bold;
      min-height: 1.1em;
      max-height: 2.3em;
      overflow-y: auto;
      margin-bottom: 6px;
    }
    .description {
      flex-grow: 1;
      min-height: 4.4em;  /* Four lines */
      margin-bottom: 0;
      overflow-y: hidden;
      /* will expand as needed */
    }
    .top-controls { position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 20; }
    .top-controls button { width: 32px; height: 32px; font-size: 16px; }
    .bottom-controls { position: fixed; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; z-index: 10; }
    button { font-size: 1.2rem; padding: 8px 12px; cursor: pointer; border: none; border-radius: 5px; background-color: #e0e0e0; color: black; }
    button:hover { background-color: #d0d0d0; }
    #shared-card-buttons { display: none; justify-content: center; gap: 10px; margin-top: 10px; }
    #exit-fullscreen-btn { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 30; padding: 10px 20px; font-size: 1rem; }
    .fullscreen-exit-wrapper { text-align: center; margin-top: 10px; }
    .fullscreen-exit-btn { background-color: #e0e0e0; border-radius: 5px; border: none; padding: 8px 12px; cursor: pointer; font-size: 1rem; color: black; transition: background 0.3s; }
    .fullscreen-exit-btn:hover { background-color: #d0d0d0; }
    body.dark-mode { background: #121212; color: #f0f0f0; }
    body.dark-mode .card { background: #232326 !important; }
    body.dark-mode .scene-heading, body.dark-mode .description {
      background: #232326 !important;
      color: #fff !important;
      border: 1px solid #444 !important;
    }
    body.dark-mode button { background-color: #333; color: white; }
    body.dark-mode button:hover { background-color: #444; }
    body.dark-mode .fullscreen-exit-btn { background-color: #333; color: white; }
    body.dark-mode .fullscreen-exit-btn:hover { background-color: #444; }
    /* ZOOM LEVEL CLASSES for uniformly scaling cards as squares */
    .zoom-1 { font-size: 14px; }
    .zoom-2 { font-size: 18px; }
    .zoom-3 { font-size: 22px; }
    .zoom-4 { font-size: 27px; }
    .card.zoom-1 { min-height: 80px; }
    .card.zoom-2 { min-height: 110px; }
    .card.zoom-3 { min-height: 160px; }
    .card.zoom-4 { min-height: 220px; }
    @media (max-width:1100px){#cards-container{grid-template-columns:repeat(2, 1fr);}}
    @media (max-width:700px){#cards-container{grid-template-columns:repeat(1, 1fr);}}
    @media print {
      #cards-container { grid-template-columns: repeat(4, 1fr) !important; gap: 3px !important; }
      .card {
        height: auto !important;
        aspect-ratio: 1 / 1 !important;
        border: none !important;
        box-shadow: none !important;
        background: white !important;
        padding: 10px 7px 8px 10px !important;
        margin: 0 !important;
      }
      .scene-heading, .description {
        display: block !important;
        border: 1px solid #888 !important;
        color: #000 !important;
        background: #fff !important;
      }
      .top-controls, .bottom-controls, h1, #shared-card-buttons, #exit-fullscreen-btn, .fullscreen-exit-wrapper {display:none !important;}
    }
    @media only screen and (max-width: 600px) {
      .bottom-controls { display: none !important; }
    }
  </style>
</head>
<body>
<div class="top-controls">
  <button id="zoomInBtn">+</button>
  <button id="zoomOutBtn">-</button>
  <button id="toggleDarkModeBtn">🌙</button>
  <button id="toggleNumberBtn">N</button>
  <button id="saveImageBtn">i</button>
  <button id="saveTextBtn">T</button>
  <button id="overallFullscreenBtn">⛶</button>
  <button id="printPreviewBtn">P</button>
</div>
<div id="cards-container"></div>
<div class="bottom-controls"><button id="addCardBtn">+</button></div>
<div id="shared-card-buttons">
  <button id="shared-add-btn">+</button>
  <button id="shared-fullscreen-btn">[]</button>
</div>
<button id="exit-fullscreen-btn">Exit Fullscreen</button>
<script>
  const cardsContainer = document.getElementById("cards-container");
  const zoomInBtn = document.getElementById("zoomInBtn");
  const zoomOutBtn = document.getElementById("zoomOutBtn");
  const addCardBtn = document.getElementById("addCardBtn");
  const printPreviewBtn = document.getElementById("printPreviewBtn");
  const toggleDarkModeBtn = document.getElementById("toggleDarkModeBtn");
  const toggleNumberBtn = document.getElementById("toggleNumberBtn");
  const saveImageBtn = document.getElementById("saveImageBtn");
  const saveTextBtn = document.getElementById("saveTextBtn");
  const overallFullscreenBtn = document.getElementById("overallFullscreenBtn");
  const sharedButtons = document.getElementById("shared-card-buttons");
  const sharedAddBtn = document.getElementById("shared-add-btn");
  const sharedFullscreenBtn = document.getElementById("shared-fullscreen-btn");
  const exitFullscreenBtn = document.getElementById("exit-fullscreen-btn");
  let isDarkMode = false, activeCard = null, numberingEnabled = false, zoomLevel = 1;

  // Auto-resize logic with limits for heading/description
  function updateCardSizes() {
    document.querySelectorAll('.card').forEach(card => {
      const heading = card.querySelector('.scene-heading');
      const desc = card.querySelector('.description');
      if (!heading || !desc) return;

      // Heading: 1 line default, extends to 2 lines max, then scrolls
      heading.style.height = 'auto';
      heading.style.overflowY = 'auto';
      const headingLine = parseFloat(getComputedStyle(heading).lineHeight) || 20;
      const headingMaxHeight = headingLine * 2;
      heading.style.height = `${Math.min(heading.scrollHeight, headingMaxHeight)}px`;

      // Description: 4 lines default, expands as user types more (never scrolls)
      const descLine = parseFloat(getComputedStyle(desc).lineHeight) || 20;
      desc.style.height = 'auto';
      if (desc.scrollHeight > desc.clientHeight) {
        desc.style.height = desc.scrollHeight + 'px';
      } else {
        desc.style.height = (descLine * 4) + 'px';
      }
      // Both have same font size
      desc.style.fontSize = heading.style.fontSize = getComputedStyle(card).fontSize;
    });
  }
  function attachInputsListeners() {
    document.querySelectorAll('.scene-heading, .description').forEach(el => {
      el.removeEventListener('input', updateCardSizes);
      el.addEventListener('input', updateCardSizes);
    });
  }
  function setActiveCard(card) {
    if (activeCard === card) return;
    activeCard = card;
    sharedButtons.style.display = 'none';
    if (activeCard) {
      activeCard.after(sharedButtons);
      sharedButtons.style.display = 'flex';
    }
  }
  function createCard(makeActive = true, insertAfter = null) {
    const card = document.createElement("div"); card.classList.add("card");
    const sceneHeading = document.createElement("textarea");
    sceneHeading.classList.add("scene-heading");
    sceneHeading.placeholder = "Scene Heading (e.g., INT. HOUSE - DAY)";
    sceneHeading.rows = 1;
    sceneHeading.style.overflowY = "auto";
    sceneHeading.addEventListener('input', updateCardSizes);
    sceneHeading.addEventListener('focus', () => setActiveCard(card));
    const description = document.createElement("textarea");
    description.classList.add("description");
    description.placeholder = "Description / Action Lines";
    description.rows = 4;
    description.addEventListener('input', updateCardSizes);
    description.addEventListener('focus', () => setActiveCard(card));
    card.appendChild(sceneHeading); card.appendChild(description);
    if (insertAfter) insertAfter.after(card); else cardsContainer.appendChild(card);
    updateZoomClass();
    attachInputsListeners();
    updateCardSizes();
    if (makeActive) { card.scrollIntoView({ behavior: "smooth", block: "nearest" }); sceneHeading.focus(); setActiveCard(card); }
  }
  function toggleNumbering() {
    numberingEnabled = !numberingEnabled;
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      const heading = card.querySelector('.scene-heading');
      if (numberingEnabled) {
        heading.value = `${index + 1}. ${heading.value.replace(/^\d+\. ?/, '')}`;
      } else {
        heading.value = heading.value.replace(/^\d+\. ?/, '');
      }
      updateCardSizes();
    });
  }
  function saveActiveCardAsJPG() {
    if (!activeCard) { alert("Please select a card to edit first."); return; }
    const isFullscreen = document.fullscreenElement === activeCard;
    let originalClass = activeCard.className;
    if (isFullscreen) { activeCard.classList.add('print-like'); }
    htmlToImage.toJpeg(activeCard, { quality: 0.95 })
      .then(function (dataUrl) {
        const link = document.createElement('a'); link.download = 'card.jpg'; link.href = dataUrl; link.click();
        if (isFullscreen) { activeCard.className = originalClass; }
      })
      .catch(function (error) { console.error('Error saving JPG:', error);
        if (isFullscreen) { activeCard.className = originalClass; }
      });
  }
  function saveCardsAsText() {
    const cards = document.querySelectorAll('.card'); let textContent = '';
    cards.forEach(card => {
      const heading = card.querySelector('.scene-heading').value.trim();
      const desc = card.querySelector('.description').value.trim();
      textContent += heading + '\n\n' + desc + '\n\n\n';
    });
    const blob = new Blob([textContent], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cards.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function createPerCardExitButton(card) {
    const existingWrapper = card.querySelector('.fullscreen-exit-wrapper');
    if (existingWrapper) existingWrapper.remove();
    const wrapper = document.createElement('div');
    wrapper.classList.add('fullscreen-exit-wrapper');
    const exitBtn = document.createElement('button');
    exitBtn.classList.add('fullscreen-exit-btn');
    exitBtn.textContent = 'Exit Fullscreen';
    exitBtn.onclick = () => document.exitFullscreen();
    wrapper.appendChild(exitBtn);
    card.appendChild(wrapper);
  }
  sharedAddBtn.addEventListener("click", () => { if (activeCard) createCard(true, activeCard); });
  sharedFullscreenBtn.addEventListener("click", () => {
    if (activeCard && !document.fullscreenElement) { activeCard.requestFullscreen(); }
    else { document.exitFullscreen(); }
  });
  overallFullscreenBtn.addEventListener("click", () => {
    if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); }
    else { document.exitFullscreen(); }
  });
  exitFullscreenBtn.addEventListener("click", () => document.exitFullscreen());
  document.addEventListener("fullscreenchange", () => {
    const fsElement = document.fullscreenElement;
    if (fsElement === document.documentElement) {
      exitFullscreenBtn.style.display = 'block';
    } else if (fsElement && fsElement.classList.contains('card')) {
      createPerCardExitButton(fsElement);
    } else {
      exitFullscreenBtn.style.display = 'none';
      document.querySelectorAll('.fullscreen-exit-wrapper').forEach(w => w.remove());
    }
  });
  addCardBtn.addEventListener("click", () => createCard(true));
  printPreviewBtn.addEventListener("click", () => window.print());
  toggleDarkModeBtn.addEventListener("click", () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle("dark-mode", isDarkMode);
    toggleDarkModeBtn.textContent = isDarkMode ? "☀️" : "🌙";
  });
  toggleNumberBtn.addEventListener("click", toggleNumbering);
  saveImageBtn.addEventListener("click", saveActiveCardAsJPG);
  saveTextBtn.addEventListener("click", saveCardsAsText);

  // --- Zoom logic ---
  function updateZoomClass() {
    document.querySelectorAll('.card').forEach(card => {
      for(let i=1; i<=4; i++) card.classList.remove('zoom-'+i);
      card.classList.add('zoom-'+zoomLevel);
    });
    updateCardSizes();
  }
  zoomInBtn.addEventListener('click', () => { if (zoomLevel < 4) { zoomLevel++; updateZoomClass(); } });
  zoomOutBtn.addEventListener('click', () => { if (zoomLevel > 1) { zoomLevel--; updateZoomClass(); } });

  // On start/setup
  createCard(true);
  attachInputsListeners();
  updateCardSizes();
</script>
</body>
</html>

